name: Build and slim rust-dev container

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  TAG_STEM: rust
  TEST_TAG: test
  LATEST_TAG: latest
  DOCKERFILE_FOLDER: ./rust/.devcontainer
  MAJOR_VERSION: 1
  DSLIM_HTTP_PROBE: false
  DOCKERHUB_REPO: aaweaver9/devcontainers

jobs:

  login:
    runs-on: ubuntu-latest
    steps:
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

  build:
    needs: login
    runs-on: ubuntu-latest

    steps:
    # Check out the repository
    - name: Check out the repository
      uses: actions/checkout@v3

    # Log the directory structure
    - name: Log directory structure
      run: |
        ls -R

    # Print the pwd with the checked-out code
    - name: Print the pwd with the checked-out code
      run: |
        pwd
        ls -R

    # # Set up QEMU
    # - name: Set up QEMU
    #   uses: docker/setup-qemu-action@v3

    # Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Build test image
    - name: Build and export to Docker
      uses: mr-smithers-excellent/docker-build-push@v6.3
      with:
        image: aaweaver-actuary/${{ env.TAG_STEM }}
        registry: docker.io
        dockerfile: ${{ env.DOCKERFILE_FOLDER }}/Dockerfile
        pushImage: false
        tags: test

    # Test the image before going further
    - name: Test
      run: |
        docker run --rm aaweaver-actuary/${{ env.TAG_STEM }}:test make testenv

    # If the test passed, build the full-size images for all platforms
    - uses: mr-smithers-excellent/docker-build-push@v6.3
      name: Build full-sized images
      with:
        image: aaweaver-actuary/${{ env.TAG_STEM }}
        registry: docker.io
        dockerfile: ${{ env.DOCKERFILE_FOLDER }}/Dockerfile
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # Slim the full-size image
    - name: Slim the full-size images
      uses: kitabisa/docker-slim-action@v1
      with:
        target: aaweaver-actuary/${{ env.TAG_STEM }}
        tag: "slim"

    # Dump the report
    - run: echo "${REPORT}"
      env:
        REPORT: ${{ steps.slim.outputs.report }}

    # Push only the slim image to Docker Hub
    - name: Push slim and full-size images to Docker Hub
      run: |
        docker image push aaweaver-actuary/${{ env.TAG_STEM }} --all-tags